name: 'run-codeql-csharp'
description:  'This action runs codeql on a C# project'
inputs:
    DEV_CONTAINER_NAME:
        description: 'The name of the devcontainer to install codeql'
        required: true
    DATABASE_NAME:
        description: 'The name of the database'
        required: true
    CS_PROJECT_NAME:
        description: 'The name of the C# project'
        required: true
    SOURCE_DIRECTORY:
        description: 'The path to the source directory'
        required: true
runs:
    using: 'composite'
    steps:
    - name: Install-code-ql
      shell: bash
      run: |
        container_name="${{ inputs.DEV_CONTAINER_NAME }}"
        database_name="${{ inputs.DATABASE_NAME }}"
        cs_proj_name="${{ inputs.CS_PROJECT_NAME }}"
        source_directory="${{ inputs.SOURCE_DIRECTORY }}"

        echo "Init database..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database init $database_name -s $source_directory --language=csharp --overwrite"
        echo ""

        echo "Download qlpacks..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql pack download codeql/csharp-queries@1.0.2"
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql pack download codeql/threat-models@1.0.2"
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql pack download codeql/csharp-solorigate-queries@1.0.1"
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql pack download codeql/csharp-solorigate-all@1.0.1"
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql pack download codeql/csharp-upgrades@0.0.7"

        echo ""

        echo "Trace commands dotnet clean..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database trace-command $database_name dotnet clean $cs_proj_name"
        echo ""

        echo "Trace commands dotnet restore..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database trace-command $database_name dotnet restore $cs_proj_name"
        echo ""

        echo "Trace commands dotnet build..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database trace-command $database_name dotnet build $cs_proj_name"
        echo ""

        echo "Database finalize..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database finalize $database_name"
        echo ""

        echo "Resolve qlpacks..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql resolve qlpacks"
        echo ""

        echo "Database Query..."
        docker exec $container_name bash -c "bash /root/codeql/codeql/codeql database analyze $database_name codeql/csharp-queries codeql/csharp-solorigate-queries --format=csv --output=/var/spacedev/tmp/analysis-results.csv"

  - name: Upload analysis results
    uses: actions/upload-artifact@v2
    with:
      name: codeql-analysis-results
      path: /var/spacedev/tmp/analysis-results.csv